<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex,nofollow">
  <title>Family Video Search</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #333; color: #fff;
      padding: 1rem; text-align: center;
    }
    #filters {
      padding: 1rem;
      display: flex; flex-wrap: wrap; gap: 1rem;
      align-items: flex-end; background: #f5f5f5;
    }
    #filters label {
      display: flex; flex-direction: column; font-size: .9rem;
    }
    #filters input,
    #filters select {
      margin-top: .25rem; padding: .25rem; font-size: 1rem;
    }
    #filters button {
      padding: .5rem 1rem; font-size: 1rem; cursor: pointer;
    }
    #gallery {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap: 1rem; padding: 1rem;
    }
    .item {
      text-decoration: none; color: inherit;
    }
    .item img {
      width: 100%; border-radius: 4px; display: block;
    }
    .title {
      margin-top: .5rem; font-size: .9rem; text-align: center;
    }
    .meta {
      font-size: .8rem; color: #666; text-align: center;
    }
    #modal {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center;
      z-index: 100;
    }
    #modal iframe {
      width: 80vw; height: 45vw;
      max-width: 960px; max-height: 540px;
      border: none; border-radius: 4px;
    }
    #modal .close {
      position: absolute; top: 1rem; right: 1rem;
      font-size: 2rem; color: white; cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Search Family Videos</h1>
  </header>

  <div id="filters">
    <label>
      Start date
      <input type="date" id="startDate">
    </label>
    <label>
      End date
      <input type="date" id="endDate">
    </label>
    <label>
      Who’s here
      <select id="participants" multiple size="5"></select>
    </label>
    <button id="apply">Apply Filters</button>
    <button id="reset">Reset</button>
  </div>

  <div id="gallery"></div>

  <div id="modal">
    <div class="close" onclick="closeModal()">×</div>
    <iframe id="player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>

  <script>
    // ── CONFIG ─────────────────────────────────────────────────────────────────
    const API_KEY     = 'AIzaSyDIyhMsMkG83shTYAyXIuo_7BEo-2WnpDA'; 
    const PLAYLIST_ID = 'PLyv7JF-f9-OiO1gt0e25RE_TVTHFs_anm';
    const MAX_RESULTS = 50;

    let allItems = [];    // { videoId, thumbnail, title, recordedAt, participants }
    let metaById = {};    // loaded from videos.json

    // load your metadata file
    async function loadMetadata() {
      const res = await fetch('videos.json');
      const arr = await res.json();
      metaById = Object.fromEntries(arr.map(m => [m.videoId, m]));
    }

    // fetch playlist pages
    async function fetchPlaylistItems(pageToken='') {
      const url = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
      url.search = new URLSearchParams({
        part:       'snippet,contentDetails',
        maxResults: MAX_RESULTS,
        playlistId: PLAYLIST_ID,
        key:        API_KEY,
        pageToken
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // initialize everything
    async function init() {
      await loadMetadata();

      // load playlist items & merge metadata
      let pageToken = '';
      do {
        const data = await fetchPlaylistItems(pageToken);
        data.items.forEach(item => {
          const vid   = item.snippet.resourceId.videoId;
          const thumb = item.snippet.thumbnails.medium.url;
          const title = item.snippet.title;
          const m     = metaById[vid] || {};
          allItems.push({
            videoId:      vid,
            thumbnail:    thumb,
            title:        title,
            recordedAt:   m.recordedAt || '',
            participants: m.participants || []
          });
        });
        pageToken = data.nextPageToken || '';
      } while (pageToken);

      buildFilters();
      renderGallery(allItems);
    }

    // build filter controls
    function buildFilters() {
      const dates = allItems
        .map(i => new Date(i.recordedAt))
        .filter(d => !isNaN(d));
      const minD = new Date(Math.min(...dates));
      const maxD = new Date(Math.max(...dates));
      const s    = document.getElementById('startDate');
      const e    = document.getElementById('endDate');
      s.min = formatDate(minD);
      s.max = formatDate(maxD);
      e.min = formatDate(minD);
      e.max = formatDate(maxD);

      const pSet = new Set();
      allItems.forEach(i => i.participants.forEach(p => pSet.add(p)));
      const sel = document.getElementById('participants');
      Array.from(pSet).sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });

      document.getElementById('apply').onclick = () => renderGallery(filterItems());
      document.getElementById('reset').onclick = () => {
        s.value = '';
        e.value = '';
        sel.selectedIndex = -1;
        renderGallery(allItems);
      };
    }

    // filter logic
    function filterItems() {
      const s      = document.getElementById('startDate').value;
      const e      = document.getElementById('endDate').value;
      const chosen = Array.from(document.getElementById('participants')
                        .selectedOptions).map(o => o.value);
      return allItems.filter(i => {
        const d = new Date(i.recordedAt);
        if (s && d < new Date(s)) return false;
        if (e && d > new Date(e + 'T23:59:59')) return false;
        if (chosen.length && !chosen.every(p => i.participants.includes(p))) return false;
        return true;
      });
    }

    // render gallery
    function renderGallery(items) {
      const c = document.getElementById('gallery');
      c.innerHTML = '';
      if (!items.length) {
        c.textContent = 'No videos match those filters.';
        return;
      }
      items.forEach(i => {
        const a = document.createElement('a');
        a.href      = '#';
        a.className = 'item';
        a.onclick   = e => { e.preventDefault(); openModal(i.videoId); };
        a.innerHTML = `
          <img src="${i.thumbnail}" alt="${i.title}">
          <div class="title">${i.title}</div>
          <div class="meta">${i.recordedAt} — ${i.participants.join(', ')}</div>
        `;
        c.appendChild(a);
      });
    }

    // modal handlers
    function openModal(id) {
      document.getElementById('player').src =
        `https://www.youtube.com/embed/${id}?autoplay=1`;
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('player').src = '';
      document.getElementById('modal').style.display = 'none';
    }

    // helpers
    function pad2(n){ return n < 10 ? '0' + n : n; }
    function formatDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    // kick it off
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
